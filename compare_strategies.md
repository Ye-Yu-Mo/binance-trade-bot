# ATR Trailing vs Risk Managed 策略对比分析

## 策略参数对比

### risk_managed_strategy (简单固定止损止盈)
- **止损**: -8% (固定)
- **止盈**: +12% (固定)
- **入场价**: 使用 ticker 价格
- **复杂度**: 简单（<100行代码）

### atr_trailing_strategy (ATR动态止损)
- **初始止损**: entry - 2.0 * ATR
- **保本触发**: 盈利 >= 1.5 * ATR 时，止损提至 entry + 0.2%
- **移动止损**: 保本后，止损 = highest - 1.5 * ATR（只升不降）
- **时间止损**: 持仓24小时且盈利 < 0.5 * ATR
- **复杂度**: 复杂（~450行代码）

## 潜在问题分析

### 1. ATR 策略可能过于保守

假设 DOGE 的 1h ATR = 2% 的价格：

```
入场价: 0.10000
ATR: 0.00200 (2%)

初始止损: 0.10000 - 2.0*0.00200 = 0.09600 (-4%)
保本触发: 0.10000 + 1.5*0.00200 = 0.10300 (+3%)
保本止损: 0.10000 + 0.0002 = 0.10020 (+0.2%)

对比 risk_managed:
  止损: -8%
  止盈: +12%
```

**问题**：
- ATR 止损 -4% vs 固定止损 -8%（ATR 更紧，更容易被假突破止损）
- ATR 保本触发 +3% 后，止损提至 +0.2%（锁定利润太早，可能错失大行情）
- ATR 移动止损距离 1.5*ATR (3%)，在震荡行情中容易被扫出

### 2. 时间止损的副作用

```python
if hold_time >= 24h and pnl < 0.5 * ATR:
    # 止损退出
```

**问题**：持仓24小时但盈利不足 1%（0.5*2%），就强制退出。这在震荡行情中会频繁交易，手续费吃光利润。

### 3. ATR 计算依赖 API

```python
klines = self.fetch_klines(coin_pair, "1h", 20)
if not klines:
    self.logger.error("ATR 数据不可用，拒绝建仓")
    return None  # 错失交易机会
```

**问题**：
- API 限频/网络抖动 → 无法建仓 → 错失机会
- risk_managed 不依赖历史数据，任何时候都能交易

## 建议的参数调整

如果要让 ATR 策略更激进（接近 risk_managed 的收益）：

```python
# 当前（保守）
self.k_initial_stop = 2.0    # -4% 止损（假设 ATR=2%）
self.k_be_trigger = 1.5      # +3% 触发保本
self.k_trail_dist = 1.5      # 3% 移动止损距离

# 建议（激进）
self.k_initial_stop = 4.0    # -8% 止损（接近 risk_managed）
self.k_be_trigger = 3.0      # +6% 触发保本
self.k_trail_dist = 2.5      # 5% 移动止损距离
self.max_hold_hours = 72     # 延长持仓时间到3天
```

## 回测对比建议

运行两个回测，对比：
1. **交易频率**: ATR 是否因止损太紧而频繁交易？
2. **平均持仓时间**: ATR 是否因时间止损而持仓太短？
3. **胜率**: 两者胜率差异
4. **最大回撤**: ATR 理论上应该更小
5. **手续费成本**: 交易次数 * 0.1% * 2（买卖双向）

## 诊断清单

运行 ATR 策略回测后，检查日志：

- [ ] "ATR 数据不可用，拒绝建仓" 的频率（应该 <1%）
- [ ] "触发时间止损" 的次数（如果太多，说明 max_hold_hours 太短）
- [ ] "保本止损激活" vs "移动止损上移" 的比例
- [ ] 平均持仓时间 vs risk_managed 的对比
- [ ] 是否有"来回切币"的现象（止损后立即换币又被止损）

## 最终判断

如果 ATR 策略回测收益 < risk_managed：

**可能原因**（按优先级）：
1. **止损太紧** → 增大 k_initial_stop 到 3.5-4.0
2. **移动止损太紧** → 增大 k_trail_dist 到 2.5-3.0
3. **时间止损太频繁** → 增大 max_hold_hours 或删除时间止损
4. **保本触发太早** → 增大 k_be_trigger 到 2.5-3.0
5. **交易频率太高** → 调整 SCOUT_MULTIPLIER，降低换币频率

**不要调整**：
- ✅ ATR 计算方法（已经是标准实现）
- ✅ 数据源（1h timeframe 适合日内交易）
- ✅ 持久化逻辑（已修复完成）
